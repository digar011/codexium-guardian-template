name: Neo Orchestrator

on:
  workflow_call:
    inputs:
      enable_automation:
        description: "Master switch for Neo automation"
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # -------------------------------------------------
  # 0. Load existing Neo memory (cost guard)
  # -------------------------------------------------
  load_memory:
    name: Load Neo Decision Memory
    runs-on: ubuntu-latest
    outputs:
      has_memory: ${{ steps.check.outputs.has_memory }}
    steps:
      - uses: actions/github-script@v7
        id: check
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const memory = comments.find(c =>
              c.body && c.body.includes("ðŸ§  Neo Decision Memory")
            );

            core.setOutput("has_memory", memory ? "true" : "false");

  # -------------------------------------------------
  # 1. Neo decision engine
  # -------------------------------------------------
  neo:
    name: Neo Decision Engine
    needs: load_memory
    if: inputs.enable_automation == true && needs.load_memory.outputs.has_memory != 'true'
    runs-on: ubuntu-latest
    outputs:
      decision: ${{ steps.decide.outputs.decision }}

    steps:
      - uses: actions/checkout@v4

      - id: decide
        name: Evaluate PR intent
        run: |
          git fetch origin main
          FILES_CHANGED=$(git diff --name-only origin/main...HEAD)

          if [ -n "$FILES_CHANGED" ] && \
             echo "$FILES_CHANGED" | grep -qiE '\.(md|txt)$' && \
             ! echo "$FILES_CHANGED" | grep -qiEv '\.(md|txt)$'; then
            echo "decision=SKIP_AUTOMATION" >> $GITHUB_OUTPUT
          else
            echo "decision=PROCEED" >> $GITHUB_OUTPUT
          fi

  # -------------------------------------------------
  # 2. Cost gate (policy hook)
  # -------------------------------------------------
  neo_cost_gate:
    name: Neo Cost Gate
    needs: neo
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.cost.outputs.allowed }}
    steps:
      - id: cost
        run: |
          echo "allowed=true" >> "$GITHUB_OUTPUT"

  # -------------------------------------------------
  # 3. Reviews (Codex Guardian)
  # -------------------------------------------------
  architect_review:
    name: Architect Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit

  security_review:
    name: Security Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit

  qa_review:
    name: QA Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit

  # -------------------------------------------------
  # 4. Aggregate signals
  # -------------------------------------------------
  neo_aggregate:
    name: Neo Aggregate Signals
    needs: [architect_review, security_review, qa_review]
    runs-on: ubuntu-latest
    outputs:
      severity: ${{ steps.out.outputs.severity }}
      confidence: ${{ steps.out.outputs.confidence }}
    steps:
      - id: out
        run: |
          echo "severity=info" >> "$GITHUB_OUTPUT"
          echo "confidence=high" >> "$GITHUB_OUTPUT"

  # -------------------------------------------------
  # 5. Merge gate (critical + high only)
  # -------------------------------------------------
  neo_gate:
    name: Neo Merge Gate
    needs: [neo, neo_aggregate]
    if: needs.neo.outputs.decision == 'PROCEED'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Gate passed"

  # -------------------------------------------------
  # 6. Persist Neo memory (Section 7)
  # -------------------------------------------------
  neo_memory:
    name: Persist Neo Decision Memory
    needs: [neo, neo_gate, neo_aggregate]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "### ðŸ§  Neo Decision Memory",
              "",
              `- **Decision:** ${"${{ needs.neo.outputs.decision || 'UNKNOWN' }}"}`,
              `- **Severity:** ${"${{ needs.neo_aggregate.outputs.severity || 'n/a' }}"}`,
              `- **Confidence:** ${"${{ needs.neo_aggregate.outputs.confidence || 'n/a' }}"}`,
              `- **Commit:** ${context.payload.pull_request.head.sha}`,
              `- **Recorded at:** ${new Date().toISOString()}`
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });



