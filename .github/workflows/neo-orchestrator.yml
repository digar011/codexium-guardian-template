name: Neo Orchestrator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  neo:
   name: Neo Decision Engine
   runs-on: ubuntu-latest
   outputs:
    decision: ${{ steps.decide.outputs.decision }}

   steps:
    - uses: actions/checkout@v4

    - id: decide
      name: Neo evaluates PR intent
      run: |
        git fetch origin main 
        FILES_CHANGED=$(git diff --name-only origin/main...HEAD)

        echo "Files changed:"
        echo "$FILES_CHANGED"

        if echo "$FILES_CHANGED" | grep -E '\.(md|txt)$' \
        && ! echo "$FILES_CHANGED" | grep -vE '\.(md|txt)$'; then
         echo "decision=SKIP_AUTOMATION" >> $GITHUB_OUTPUT
           else
               echo "decision=PROCEED" >> $GITHUB_OUTPUT
          fi

  architect_review:
    name: Architect Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
      prompt: |
        Review this PR as a Staff Software Architect.
        Focus on:
        - system design
        - scalability
        - maintainability
        - architectural risks

  security_review:
    name: Security Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
      prompt: |
        Review this PR as a Security Engineer.
        Focus on:
        - vulnerabilities
        - secrets exposure
        - auth/authz risks
        - dependency risks

  qa_review:
    name: QA Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
      prompt: |
        Review this PR as a QA Engineer.
        Focus on:
        - edge cases
        - missing tests
        - regressions
        - failure scenarios


  neo_review:
   name: Neo Multi-Perspective Review
   needs: neo
   if: needs.neo.outputs.decision != 'SKIP_AUTOMATION'
   runs-on: ubuntu-latest

   permissions:
    contents: read
    pull-requests: write
    issues: write

   steps:
    - uses: actions/checkout@v4

    - name: Run Neo review (PM, QA, Security, TL)
      uses: openai/codex-action@v1
      with:
        openai-api-key: ${{ secrets.OPENAI_API_KEY }}
        prompt: |
          You are Neo, the Codexium V4 AI Dev Team.

          Perform a structured pull request review from four roles:
          1. Product Manager – scope, clarity, risks
          2. Tech Lead – architecture, correctness
          3. QA – edge cases, test gaps
          4. Security – vulnerabilities, secrets, permissions

          Review ONLY the diff in this PR.
          Be concise, actionable, and role-labeled.
