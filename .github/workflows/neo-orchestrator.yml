name: Neo Orchestrator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  neo:
    runs-on: ubuntu-latest
    outputs:
      decision: ${{ steps.decide.outputs.decision }}

    steps:
      - uses: actions/checkout@v4

      - name: Decide automation path
        id: decide
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          if [ "$FILES_CHANGED" -gt 10 ]; then
            echo "decision=RUN_CODEX_FULL" >> $GITHUB_OUTPUT
          else
            echo "decision=RUN_CODEX_LIGHT" >> $GITHUB_OUTPUT
          fi

  neo_review:
   name: Neo Multi-Perspective Review
   needs: neo
   if: needs.neo.outputs.decision != 'SKIP_AUTOMATION'
   runs-on: ubuntu-latest

   permissions:
    contents: read
    pull-requests: write
    issues: write

   steps:
    - uses: actions/checkout@v4

    - name: Run Neo review (PM, QA, Security, TL)
      uses: openai/codex-action@v1
      with:
        openai-api-key: ${{ secrets.OPENAI_API_KEY }}
        prompt: |
          You are Neo, the Codexium V4 AI Dev Team.

          Perform a structured pull request review from four roles:
          1. Product Manager – scope, clarity, risks
          2. Tech Lead – architecture, correctness
          3. QA – edge cases, test gaps
          4. Security – vulnerabilities, secrets, permissions

          Review ONLY the diff in this PR.
          Be concise, actionable, and role-labeled.
