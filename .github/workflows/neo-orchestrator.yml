name: Neo Orchestrator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  neo:
   name: Neo Decision Engine
   if: vars.NEO_AUTOMATION_ENABLED == 'true'
   runs-on: ubuntu-latest
   outputs:
    decision: ${{ steps.decide.outputs.decision }}

   steps:
    - uses: actions/checkout@v4

    - id: decide
      name: Neo evaluates PR intent
      run: |
        git fetch origin main 
        FILES_CHANGED=$(git diff --name-only origin/main...HEAD)

        echo "Files changed:"
        echo "$FILES_CHANGED"

        if [ -n "$FILES_CHANGED" ] && \
           echo "$FILES_CHANGED" | grep -qiE '\.(md|txt)$' && \
           ! echo "$FILES_CHANGED" | grep -qiEv '\.(md|txt)$'; then
         echo "decision=SKIP_AUTOMATION" >> $GITHUB_OUTPUT
           else
               echo "decision=PROCEED" >> $GITHUB_OUTPUT
          fi

  neo_labels:
    name: Neo Auto Labels
    needs: neo
    if: vars.NEO_AUTOMATION_ENABLED == 'true' && needs.neo.outputs.decision == 'PROCEED'
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Determine labels
        id: labels
        run: |
          git fetch origin main 
          FILES=$(git diff --name-only origin/main...HEAD)

          LABELS=""

          if echo "$FILES" | grep -qE '(^|/)(auth|security|env|config)(/|\.|$)'; then
            LABELS="$LABELS security-risk"
          fi

          if echo "$FILES" | grep -qE '(infra|docker|terraform|k8s)'; then
            LABELS="$LABELS needs-architecture"
          fi

          if echo "$FILES" | grep -qE '\.(ts|js|py|go|java)$'; then
            LABELS="$LABELS needs-qa"
          fi

          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const labels = '${{ steps.labels.outputs.labels }}'
              .split(' ')
              .filter(Boolean)

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels
              })
            }

  neo_cost_gate:
      name: Neo Cost Gate (placeholder)
      needs: neo
      runs-on: ubuntu-latest
      
      outputs:
       allowed: ${{ steps.cost.outputs.allowed }}
       
      steps:
          - id: cost
            name: Evaluate cost policy (placeholder)
            run: |
             echo "Neo Cost Gate: placeholder â€” no enforcement active."

             if [ "${{ vars.NEO_AUTOMATION_ENABLED }}" = "true" ]; then
              echo "allowed=true" >> "$GITHUB_OUTPUT"
              echo "Cost gate PASSED (automation enabled)."
              else
              echo "allowed=false" >> "$GITHUB_OUTPUT"
              echo "Cost gate FAILED (automation disabled)."
             fi

  architect_review:
    name: Architect Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
     prompt: |
       Review this PR as a Staff Software Architect.

       You MUST output:
       - Severity: info | warn | critical
       - Confidence: low | medium | high

       Focus on:
       - system design
       - scalability
       - maintainability
       - architectural risks

       Output format (exact):
       Severity: <info|warn|critical>
       Confidence: <low|medium|high>
       Notes:
       - concise findings


  security_review:
    name: Security Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
      prompt: |
        Review this PR as a Security Engineer.

        You MUST output:
        - Severity: info | warn | critical
        - Confidence: low | medium | high

        Focus on:
        - vulnerabilities
        - secrets exposure
        - auth/authz risks
        - dependency risks

        Output format (exact):
        Severity: <info|warn|critical>
        Confidence: <low|medium|high>
        Notes:
        - concise findings


  qa_review:
    name: QA Review
    needs: [neo, neo_cost_gate]
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    
    with:
      prompt: |
        Review this PR as a QA Engineer.

        You MUST output:
        - Severity: info | warn | critical
        - Confidence: low | medium | high

        Focus on:
        - edge cases
        - missing tests
        - regressions
        - failure scenarios

        Output format (exact):
        Severity: <info|warn|critical>
        Confidence: <low|medium|high>
        Notes:
        - concise findings


  neo_gate:
    name: Neo Merge Gate (critical-only)
    needs: [neo, neo_cost_gate, architect_review, security_review, qa_review]
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Evaluate critical findings
        run: |
          # This gate is conservative by design.
          # It blocks ONLY on "Severity: critical" + "Confidence: high".
          # If outputs are unavailable, it does NOT block.

          BLOCK=false

          check() {
            echo "$1" | grep -qi "Severity:\s*critical" && \
            echo "$1" | grep -qi "Confidence:\s*high" && BLOCK=true
          }

          check "${{ needs.architect_review.outputs.review || '' }}"
          check "${{ needs.security_review.outputs.review || '' }}"
          check "${{ needs.qa_review.outputs.review || '' }}"

          if [ "$BLOCK" = true ]; then
            echo "Blocking merge due to critical, high-confidence finding."
            exit 1
          fi

          echo "No critical blockers detected."


  neo_memory:
    name: Neo Memory (V4)
    needs: [neo, neo_gate, architect_review, security_review, qa_review]
    if: vars.NEO_AUTOMATION_ENABLED == 'true' && needs.neo.outputs.decision == 'PROCEED'
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Write workflow summary
        run: |
          echo "## ðŸ§  Neo Memory Record (V4)" >> $GITHUB_STEP_SUMMARY
          echo "- Decision: ${{ needs.neo_gate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

      - name: Write Neo memory record
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const decision =
              '${{ needs.neo_gate.result }}' === 'success'
                ? 'ALLOW'
                : 'BLOCK'

            const timestamp = new Date().toISOString()
            const sha = context.payload.pull_request.head.sha

            const body = [
              '### ðŸ§  Neo Memory Record (V4)',
              '',
              `- **Decision:** ${decision}`,
              '- **Severity:** derived',
              '- **Confidence:** derived',
              '- **Source:** guardian consensus',
              `- **Timestamp:** ${timestamp}`,
              `- **Commit:** ${sha}`
            ].join('\n')

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            })


 
  neo_consensus:
        name: Neo Consensus
        needs: [neo, neo_cost_gate, architect_review, security_review, qa_review]
        if: vars.NEO_AUTOMATION_ENABLED == 'true' && needs.neo.outputs.decision == 'PROCEED'
        runs-on: ubuntu-latest

        permissions:
          pull-requests: write

        steps:
        - name: Post Neo consensus
          uses: actions/github-script@v7
          with:
           github-token: ${{ github.token }}
           script: |
             await github.rest.issues.createComment({
               owner: context.repo.owner,
               repo: context.repo.repo,
               issue_number: context.payload.pull_request.number,
               body: `**Neo consensus:** Review completed. See above notes before merging.`
              })
   
        - name: Write Neo decision memory
          if: always()
          env:
             GITHUB_TOKEN: ${{ github.token }}
             NEO_DECISION_JSON: |
              {
              "pr": "${{ github.event.pull_request.number }}",
              "commit": "${{ github.sha }}",
              "decision": "${{ needs.neo.outputs.decision }}",
              "severity": "${{ needs.neo.outputs.severity || 'unknown' }}",
              "confidence": "${{ needs.neo.outputs.confidence || 'unknown' }}",
              "model": "gpt-4.1",
              "timestamp": "${{ github.run_started_at }}"
               }
          run: |
            echo "## Neo Decision Memory" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$NEO_DECISION_JSON" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
 
            gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ðŸ§  Neo Decision Memory\n\`\`\`json\n$NEO_DECISION_JSON\n\`\`\`"
