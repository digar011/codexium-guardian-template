name: Neo Orchestrator

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

jobs:
  neo:
   name: Neo Decision Engine
   runs-on: ubuntu-latest
   outputs:
    decision: ${{ steps.decide.outputs.decision }}

   steps:
    - uses: actions/checkout@v4

    - id: decide
      name: Neo evaluates PR intent
      run: |
        git fetch origin main 
        FILES_CHANGED=$(git diff --name-only origin/main...HEAD)

        echo "Files changed:"
        echo "$FILES_CHANGED"

        if echo "$FILES_CHANGED" | grep -E '\.(md|txt)$' \
        && ! echo "$FILES_CHANGED" | grep -vE '\.(md|txt)$'; then
         echo "decision=SKIP_AUTOMATION" >> $GITHUB_OUTPUT
           else
               echo "decision=PROCEED" >> $GITHUB_OUTPUT
          fi

  neo_labels:
    name: Neo Auto Labels
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED'
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Determine labels
        id: labels
        run: |
          FILES=$(git diff --name-only origin/main...HEAD)

          LABELS=""

          if echo "$FILES" | grep -qE '(auth|security|env|config)'; then
            LABELS="$LABELS security-risk"
          fi

          if echo "$FILES" | grep -qE '(infra|docker|terraform|k8s)'; then
            LABELS="$LABELS needs-architecture"
          fi

          if echo "$FILES" | grep -qE '\.(ts|js|py|go|java)$'; then
            LABELS="$LABELS needs-qa"
          fi

          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const labels = '${{ steps.labels.outputs.labels }}'
              .split(' ')
              .filter(Boolean)

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels
              })
            }

  neo_cost_gate:
    name: Neo Cost Gate
    needs: neo
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.cost.outputs.allowed }}

    steps:
      - id: cost
        run: |
          if [ "${{ vars.NEO_AUTOMATION_ENABLED }}" = "true" ]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
          fi



  architect_review:
    name: Architect Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
     prompt: |
       Review this PR as a Staff Software Architect.

       You MUST output:
       - Severity: info | warn | critical
       - Confidence: low | medium | high

       Focus on:
       - system design
       - scalability
       - maintainability
       - architectural risks

       Output format (exact):
       Severity: <info|warn|critical>
       Confidence: <low|medium|high>
       Notes:
       - concise findings


  security_review:
    name: Security Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    with:
      prompt: |
        Review this PR as a Security Engineer.

        You MUST output:
        - Severity: info | warn | critical
        - Confidence: low | medium | high

        Focus on:
        - vulnerabilities
        - secrets exposure
        - auth/authz risks
        - dependency risks

        Output format (exact):
        Severity: <info|warn|critical>
        Confidence: <low|medium|high>
        Notes:
        - concise findings


  qa_review:
    name: QA Review
    needs: neo
    if: needs.neo.outputs.decision == 'PROCEED' && needs.neo_cost_gate.outputs.allowed == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets: inherit
    
    with:
      prompt: |
        Review this PR as a QA Engineer.

        You MUST output:
        - Severity: info | warn | critical
        - Confidence: low | medium | high

        Focus on:
        - edge cases
        - missing tests
        - regressions
        - failure scenarios

        Output format (exact):
        Severity: <info|warn|critical>
        Confidence: <low|medium|high>
        Notes:
        - concise findings


  neo_gate:
    name: Neo Merge Gate (critical-only)
    needs: [architect_review, security_review, qa_review]
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Evaluate critical findings
        run: |
          # This gate is conservative by design.
          # It blocks ONLY on "Severity: critical" + "Confidence: high".
          # If outputs are unavailable, it does NOT block.

          BLOCK=false

          check() {
            echo "$1" | grep -qi "Severity:\s*critical" && \
            echo "$1" | grep -qi "Confidence:\s*high" && BLOCK=true
          }

          check "${{ needs.architect_review.outputs.review || '' }}"
          check "${{ needs.security_review.outputs.review || '' }}"
          check "${{ needs.qa_review.outputs.review || '' }}"

          if [ "$BLOCK" = true ]; then
            echo "Blocking merge due to critical, high-confidence finding."
            exit 1
          fi

          echo "No critical blockers detected."


 
  neo_consensus:
        name: Neo Consensus
        needs: [architect_review, security_review, qa_review]
        runs-on: ubuntu-latest

        permissions:
          pull-requests: write

        steps:
        - name: Post Neo consensus
          uses: actions/github-script@v7
          with:
           github-token: ${{ github.token }}
           script: |
             await github.rest.issues.createComment({
               owner: context.repo.owner,
               repo: context.repo.repo,
               issue_number: context.payload.pull_request.number,
               body: `**Neo consensus:** Review completed. See above notes before merging.`
              })
   
