name: Codex Materializer

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: "Task identifier (e.g. v4-docs-baseline)"
        required: true
        type: string
      target_path:
        description: "Target directory (e.g. docs)"
        required: true
        type: string
      files:
        description: |
          JSON object mapping filename -> file content.
          Example: {"README.md": "# Title\n\nContent", "GUIDE.md": "Guide text"}
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  materialize:
    name: Materialize Files
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2Ô∏è‚É£ Validate JSON early
      - name: Validate JSON input
        run: |
          echo "üîç Validating JSON input..."
          echo '${{ inputs.files }}' | jq empty
          echo "‚úÖ JSON is valid"
      
      # 3Ô∏è‚É£ Create target directory
      - name: Create target directory
        run: |
          mkdir -p "${{ inputs.target_path }}"
          echo "üìÅ Created directory: ${{ inputs.target_path }}"
      
      # 4Ô∏è‚É£ Write files (FIXED VERSION)
      - name: Write files from JSON
        run: |
          set -euo pipefail
          
          echo "üìù Writing files..."
          
          # Parse JSON and write each file
          echo '${{ inputs.files }}' | jq -r 'to_entries[] | 
            @json "\(.key)\t\(.value)"
          ' | while IFS=$'\t' read -r filename content; do
            # Remove JSON quotes
            filename=$(echo "$filename" | jq -r '.')
            content=$(echo "$content" | jq -r '.')
            
            # Skip empty
            if [ -z "$filename" ] || [ "$filename" = "null" ]; then
              continue
            fi
            
            # Build path
            filepath="${{ inputs.target_path }}/${filename}"
            
            echo "  ‚Üí Writing: $filepath"
            
            # Create parent directory
            mkdir -p "$(dirname "$filepath")"
            
            # Write file (handle newlines properly)
            printf '%s\n' "$content" > "$filepath"
            
            # Verify
            if [ -f "$filepath" ]; then
              echo "    ‚úÖ $(wc -l < "$filepath") lines written"
            else
              echo "    ‚ùå Failed to write file"
              exit 1
            fi
          done
          
          echo "‚úÖ All files written"
      
      # 5Ô∏è‚É£ Verify what was created
      - name: Verify files
        run: |
          echo "üìã Files in ${{ inputs.target_path }}:"
          ls -lah "${{ inputs.target_path }}"
          
          echo ""
          echo "üìä Git status:"
          git status --short
          
          echo ""
          echo "üìà Changes summary:"
          git diff --stat || echo "No changes detected"
      
      # 6Ô∏è‚É£ Create PR (this handles commit + push + PR creation)
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "codex: materialize ${{ inputs.task_id }}"
          committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          author: "${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>"
          branch: "codex/${{ inputs.task_id }}"
          delete-branch: true
          title: "ü§ñ Codex: ${{ inputs.task_id }}"
          body: |
            ## ü§ñ Codexium V4 - Materialized Output
            
            **Task:** `${{ inputs.task_id }}`  
            **Target Path:** `${{ inputs.target_path }}`  
            **Generated:** $(date -u +"%Y-%m-%d %H:%M UTC")
            
            This PR was automatically generated by **Codexium V4 Materializer**.
            
            ### üìã What's included
            - Deterministic output only
            - V4 quality standards enforced
            - Ready for human review
            
            ### ‚úÖ Next steps
            1. Review the generated files
            2. Request changes if needed
            3. Approve and merge
            
            ---
            <sub>‚ö†Ô∏è **Do not auto-merge** - Human approval required</sub>
          labels: |
            codex
            automated
            needs-review
          draft: false
      
      # 7Ô∏è‚É£ Output results
      - name: PR Created Successfully
        if: steps.cpr.outputs.pull-request-number != ''
        run: |
          echo "‚úÖ Pull Request created successfully!"
          echo ""
          echo "üìã Details:"
          echo "  PR Number: #${{ steps.cpr.outputs.pull-request-number }}"
          echo "  PR URL: ${{ steps.cpr.outputs.pull-request-url }}"
          echo "  Branch: codex/${{ inputs.task_id }}"
          echo ""
          echo "üîó View PR: ${{ steps.cpr.outputs.pull-request-url }}"
      
      - name: No Changes Detected
        if: steps.cpr.outputs.pull-request-number == ''
        run: |
          echo "‚ÑπÔ∏è No changes detected"
          echo ""
          echo "This usually means:"
          echo "  - Files already exist with identical content"
          echo "  - No modifications were made"
          echo ""
          echo "If this is unexpected, check:"
          echo "  1. The JSON input format"
          echo "  2. File paths in target_path"
          echo "  3. Git diff output above"
      
      # 8Ô∏è‚É£ Send Slack notification (optional)
      - name: Notify Slack
        if: steps.cpr.outputs.pull-request-number != '' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "text": "ü§ñ Codexium V4 Materializer",
            "attachments": [
              {
                "color": "good",
                "title": "PR #${{ steps.cpr.outputs.pull-request-number }}: ${{ inputs.task_id }}",
                "title_link": "${{ steps.cpr.outputs.pull-request-url }}",
                "fields": [
                  {
                    "title": "Task",
                    "value": "${{ inputs.task_id }}",
                    "short": true
                  },
                  {
                    "title": "Path",
                    "value": "${{ inputs.target_path }}",
                    "short": true
                  }
                ],
                "footer": "Codexium V4 Materializer"
              }
            ]
          }
          EOF
