name: Codex Materializer (Guardian)

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: "Codex task identifier (e.g. v4-docs-baseline)"
        required: true
      target_path:
        description: "Target directory (e.g. docs)"
        required: true
      files:
        description: |
          JSON object mapping filename -> file content.
          Example:
          {
            "README.md": "# Title",
            "SERVICES.md": "Content"
          }
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  materialize:
    name: Materialize Codex Output
    runs-on: ubuntu-latest

    # ðŸ§¯ Global safety switch
    if: vars.NEO_AUTOMATION_ENABLED == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON payload
        run: |
          echo '${{ inputs.files }}' | jq type > /dev/null

      - name: Create target directory
        run: |
          mkdir -p "${{ inputs.target_path }}"

      - name: Write files
        run: |
          echo '${{ inputs.files }}' \
            | jq -r 'to_entries[] | "\(.key)\u0000\(.value)"' \
            | while IFS=$'\0' read -r filename content; do
                echo "Writing $filename"
                echo "$content" > "${{ inputs.target_path }}/$filename"
              done

      - name: Configure git identity
        run: |
          git config user.name "codexium-guardian-bot"
          git config user.email "guardian@codexium.ai"

      - name: Create branch
        run: |
          git checkout -b codex/${{ inputs.task_id }}

      - name: Commit changes
        run: |
          git add "${{ inputs.target_path }}"
          git commit -m "codex: materialize ${{ inputs.task_id }}"

      - name: Push branch
        run: |
          git push origin codex/${{ inputs.task_id }}

      - name: Open pull request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: codex/${{ inputs.task_id }}
          title: "Codex: ${{ inputs.task_id }}"
          body: |
            ## Codex Materialized Output

            **Task:** ${{ inputs.task_id }}
            **Target:** `${{ inputs.target_path }}`

            This PR was generated by **Codex Guardian**.
            - Requires V4 Guardian review
            - Human approval required
            - No auto-merge

          labels: |
            codex
            guardian
            automated

