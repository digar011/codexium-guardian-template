name: Codex Guardian Review

on:
  workflow_call:
    inputs:
      role:
        description: "Review role (architect, security, qa, or general)"
        required: false
        type: string
        default: "general"
    secrets:
      OPENAI_API_KEY:
        required: true
    outputs:
      review_output:
        description: "AI review content"
        value: ${{ jobs.review.outputs.review_text }}
      severity:
        description: "Issue severity (info, warn, critical)"
        value: ${{ jobs.review.outputs.severity }}

jobs:
  review:
    name: ${{ inputs.role }} Review
    runs-on: ubuntu-latest
    outputs:
      review_text: ${{ steps.ai_review.outputs.review }}
      severity: ${{ steps.parse.outputs.severity }}
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: diff
        run: |
          # Get the diff for this PR
          git fetch origin ${{ github.base_ref }}
          
          # Create diff file
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr_diff.txt
          
          # Get list of changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed_files.txt
          
          echo "files_changed=$(cat /tmp/changed_files.txt | wc -l)" >> $GITHUB_OUTPUT
      
      - name: Build review prompt
        id: prompt
        run: |
          # Set role-specific instructions
          case "${{ inputs.role }}" in
            architect)
              ROLE_INSTRUCTION="You are a senior software architect. Focus on:
              - Design patterns and architecture decisions
              - Code organization and modularity
              - Scalability and maintainability
              - Technical debt and refactoring opportunities"
              ;;
            security)
              ROLE_INSTRUCTION="You are a security engineer. Focus on:
              - Authentication and authorization issues
              - Data validation and sanitization
              - Sensitive data exposure
              - Common vulnerabilities (SQL injection, XSS, CSRF, etc.)
              - Dependency vulnerabilities"
              ;;
            qa)
              ROLE_INSTRUCTION="You are a QA engineer. Focus on:
              - Edge cases and error handling
              - Test coverage gaps
              - Input validation
              - User experience issues
              - Performance concerns"
              ;;
            *)
              ROLE_INSTRUCTION="You are an experienced code reviewer. Provide balanced feedback on:
              - Code quality and readability
              - Potential bugs or issues
              - Best practices
              - Performance considerations"
              ;;
          esac
          
          # Save to file for API call
          cat > /tmp/role_instruction.txt << 'EOF'
          $ROLE_INSTRUCTION
          EOF
      
      - name: Call GPT-4 for review
        id: ai_review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Read the diff (truncate if too large for API)
          DIFF_CONTENT=$(head -c 30000 /tmp/pr_diff.txt)
          ROLE_INSTRUCTION=$(cat /tmp/role_instruction.txt)
          
          # Build prompt in file to avoid JSON escaping issues
          ROLE_INST=$(cat /tmp/role_instruction.txt)
          CHANGED_FILES=$(cat /tmp/changed_files.txt)
          
          # Build complete prompt
          {
            cat /tmp/role_instruction.txt
            echo ""
            echo "## Pull Request Details"
            echo "- Repository: ${{ github.repository }}"
            echo "- PR: #${{ github.event.pull_request.number }}"
            echo "- Title: ${{ github.event.pull_request.title }}"
            echo "- Author: ${{ github.event.pull_request.user.login }}"
            echo ""
            echo "## Changed Files"
            cat /tmp/changed_files.txt
            echo ""
            echo "## Code Changes"
            echo '```diff'
            head -c 30000 /tmp/pr_diff.txt
            echo '```'
            echo ""
            echo "Provide a concise code review. Format your response as:"
            echo ""
            echo "**Severity:** [info/warn/critical]"
            echo ""
            echo "**Summary:** [1-2 sentence overview]"
            echo ""
            echo "**Findings:**"
            echo "- [Key finding 1]"
            echo ""
            echo "**Recommendations:**"
            echo "- [Specific actionable recommendation]"
            echo ""
            echo "Keep it concise and actionable."
          } > /tmp/prompt_final.txt
          
          # Build JSON payload properly
          PROMPT_JSON=$(cat /tmp/prompt_final.txt | jq -Rs .)
          
          # Create JSON payload file to avoid shell escaping issues
          cat > /tmp/api_payload.json <<PAYLOAD_EOF
{
  "model": "gpt-4-turbo-preview",
  "messages": [
    {
      "role": "system",
      "content": "You are Codexium V4, an AI code reviewer. Be concise, specific, and constructive."
    },
    {
      "role": "user",
      "content": ${PROMPT_JSON}
    }
  ],
  "temperature": 0.3,
  "max_tokens": 1500
}
PAYLOAD_EOF
          
          # Call OpenAI API with JSON file
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/api_payload.json)
          
          # Extract the review text
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # Check if we got an error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            echo "‚ùå OpenAI API Error:"
            echo "$RESPONSE" | jq '.error'
            exit 1
          fi
          
          # Save review to output
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also save to file for next step
          echo "$REVIEW_TEXT" > /tmp/review.txt
      
      - name: Parse severity
        id: parse
        run: |
          REVIEW=$(cat /tmp/review.txt)
          
          # Extract severity (default to info if not found)
          if echo "$REVIEW" | grep -qi "critical"; then
            echo "severity=critical" >> $GITHUB_OUTPUT
          elif echo "$REVIEW" | grep -qi "warn"; then
            echo "severity=warn" >> $GITHUB_OUTPUT
          else
            echo "severity=info" >> $GITHUB_OUTPUT
          fi
      
      - name: Output review summary
        run: |
          echo "### ü§ñ ${{ inputs.role }} Review Complete"
          echo ""
          echo "**Severity:** ${{ steps.parse.outputs.severity }}"
          echo ""
          cat /tmp/review.txt
