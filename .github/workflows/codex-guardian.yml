name: Codex Guardian Review

on:
  workflow_call:
    inputs:
      model:
        required: false
        type: string
        default: gpt-4.1
    secrets:
      OPENAI_API_KEY:
        required: true
    outputs:
      review:
        description: "Codex Guardian review output"
        value: ${{ jobs.codex.outputs.review }}

jobs:
  codex:
    runs-on: ubuntu-latest
    outputs:
      review: ${{ steps.export.outputs.review }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Codex review
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: ${{ inputs.model }}
          prompt: |
            Review this pull request.

            You MUST output:
            Severity: info | warn | critical
            Confidence: low | medium | high
            Notes:
            - concise findings

      - name: Export review output
        id: export
        run: |
          echo "review<<EOF" >> "$GITHUB_OUTPUT"
          echo "${{ steps.codex.outputs.text }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
