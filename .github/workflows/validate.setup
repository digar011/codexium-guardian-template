#!/bin/bash
# Codexium V4 - Setup Validation Script
# Run this to verify your installation is correct

set -e

echo "ü§ñ Codexium V4 - Setup Validation"
echo "=================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILURES=0

# Helper functions
pass() {
    echo -e "${GREEN}‚úÖ PASS${NC}: $1"
}

fail() {
    echo -e "${RED}‚ùå FAIL${NC}: $1"
    FAILURES=$((FAILURES + 1))
}

warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARN${NC}: $1"
}

info() {
    echo "‚ÑπÔ∏è  $1"
}

# Test 1: Check we're in a git repo
echo "Test 1: Git Repository"
if git rev-parse --git-dir > /dev/null 2>&1; then
    pass "Git repository detected"
else
    fail "Not a git repository. Run: git init"
fi
echo ""

# Test 2: Check workflow directory exists
echo "Test 2: Workflow Directory"
if [ -d ".github/workflows" ]; then
    pass ".github/workflows directory exists"
else
    fail ".github/workflows directory not found"
    info "Create it with: mkdir -p .github/workflows"
fi
echo ""

# Test 3: Check workflow files
echo "Test 3: Workflow Files"
REQUIRED_FILES=(
    ".github/workflows/codex-guardian.yml"
    ".github/workflows/pr-review.yml"
    ".github/workflows/codex-materialize.yml"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ -f "$file" ]; then
        pass "Found: $file"
    else
        fail "Missing: $file"
    fi
done
echo ""

# Test 4: Validate YAML syntax
echo "Test 4: YAML Syntax Validation"
if command -v yamllint &> /dev/null; then
    for file in "${REQUIRED_FILES[@]}"; do
        if [ -f "$file" ]; then
            if yamllint "$file" &> /dev/null; then
                pass "Valid YAML: $file"
            else
                fail "Invalid YAML: $file"
                info "Check syntax at yamllint.com"
            fi
        fi
    done
else
    warn "yamllint not installed - skipping YAML validation"
    info "Install with: pip install yamllint"
fi
echo ""

# Test 5: Check for OpenAI API key secret
echo "Test 5: GitHub Secrets Check"
if gh secret list 2>/dev/null | grep -q "OPENAI_API_KEY"; then
    pass "OPENAI_API_KEY secret is set"
else
    if command -v gh &> /dev/null; then
        fail "OPENAI_API_KEY secret not found"
        info "Set it with: gh secret set OPENAI_API_KEY"
    else
        warn "GitHub CLI not installed - cannot check secrets"
        info "Install from: https://cli.github.com/"
        info "Or set secrets manually in GitHub UI"
    fi
fi

if command -v gh &> /dev/null; then
    if gh secret list 2>/dev/null | grep -q "SLACK_WEBHOOK_URL"; then
        pass "SLACK_WEBHOOK_URL secret is set (optional)"
    else
        info "SLACK_WEBHOOK_URL not set (optional - for notifications)"
    fi
fi
echo ""

# Test 6: Check repository permissions
echo "Test 6: Repository Permissions"
if command -v gh &> /dev/null; then
    REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")
    if [ -n "$REPO" ]; then
        pass "Repository: $REPO"
        
        # Check if Actions are enabled
        info "Check Settings ‚Üí Actions to ensure:"
        info "  1. Workflows are enabled"
        info "  2. Read/write permissions granted"
        info "  3. Allow Actions to create PRs"
    else
        warn "Could not detect repository"
    fi
else
    warn "GitHub CLI not installed - skipping permission check"
fi
echo ""

# Test 7: Check for test files
echo "Test 7: Documentation Check"
if [ -f "DEPLOYMENT_GUIDE.md" ]; then
    pass "Deployment guide found"
else
    warn "DEPLOYMENT_GUIDE.md not found"
    info "This has setup instructions"
fi
echo ""

# Test 8: Validate JSON handling (for materialize workflow)
echo "Test 8: JSON Tools Check"
if command -v jq &> /dev/null; then
    pass "jq is installed (required for materialize workflow)"
    
    # Test JSON parsing
    TEST_JSON='{"test.md": "# Test\n\nContent"}'
    if echo "$TEST_JSON" | jq empty 2>/dev/null; then
        pass "JSON parsing works"
    else
        fail "JSON parsing failed"
    fi
else
    fail "jq not installed (required)"
    info "Install with: sudo apt-get install jq (Ubuntu/Debian)"
    info "            : brew install jq (macOS)"
fi
echo ""

# Test 9: Check if we can create a test branch
echo "Test 9: Git Operations Check"
CURRENT_BRANCH=$(git branch --show-current)
if git checkout -b codexium-test-branch 2>/dev/null; then
    pass "Can create branches"
    git checkout "$CURRENT_BRANCH" 2>/dev/null
    git branch -D codexium-test-branch 2>/dev/null
else
    warn "Could not create test branch (might be in detached HEAD)"
fi
echo ""

# Test 10: Check GitHub Actions status
echo "Test 10: GitHub Actions Status"
if command -v gh &> /dev/null; then
    WORKFLOW_STATUS=$(gh run list --limit 1 --json status -q '.[0].status' 2>/dev/null || echo "none")
    if [ "$WORKFLOW_STATUS" != "none" ]; then
        info "Latest workflow status: $WORKFLOW_STATUS"
        pass "GitHub Actions is active"
    else
        info "No workflow runs found yet"
        info "Workflows will run on first PR"
    fi
else
    info "Install GitHub CLI to check workflow status"
fi
echo ""

# Summary
echo "=================================="
echo "üìä Validation Summary"
echo "=================================="
echo ""

if [ $FAILURES -eq 0 ]; then
    echo -e "${GREEN}üéâ All critical checks passed!${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Push workflow files to GitHub"
    echo "  2. Set OPENAI_API_KEY secret (if not done)"
    echo "  3. Create a test PR to trigger review"
    echo ""
    echo "See DEPLOYMENT_GUIDE.md for detailed instructions"
else
    echo -e "${RED}‚ùå $FAILURES check(s) failed${NC}"
    echo ""
    echo "Fix the issues above before deploying"
    echo "See DEPLOYMENT_GUIDE.md for help"
fi

echo ""
echo "=================================="

exit $FAILURES
