name: Codexium Comment Trigger

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write

jobs:
  parse-and-trigger:
    runs-on: ubuntu-latest
    if: startsWith(github.event.comment.body, '/codexium')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests --break-system-packages

      - name: Parse command
        id: parse
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          
          # Get comment body
          comment_body = """${{ github.event.comment.body }}"""
          
          # Parse /codexium command
          # Format: /codexium <request text>
          # Optional: Add "context:" on new line for additional context
          
          lines = comment_body.strip().split('\n')
          first_line = lines[0]
          
          # Extract request (everything after /codexium)
          if first_line.startswith('/codexium'):
            request = first_line.replace('/codexium', '', 1).strip()
          else:
            request = ""
          
          # Check for context in subsequent lines
          context = ""
          for line in lines[1:]:
            if line.strip():
              context += line + "\n"
          
          context = context.strip()
          
          # Validate
          if not request:
            print("‚ùå No request found after /codexium command")
            exit(1)
          
          # Save to outputs
          # Use heredoc to avoid escaping issues
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"request<<EOF\n{request}\nEOF\n")
            f.write(f"context<<EOF\n{context}\nEOF\n")
          
          print(f"‚úÖ Parsed request: {request}")
          print(f"üìù Context: {context if context else '(none)'}")
          PYTHON_SCRIPT

      - name: Post acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const request = `${{ steps.parse.outputs.request }}`;
            const context_text = `${{ steps.parse.outputs.context }}`;
            
            const body = `## ü§ñ Codexium V4 Request Received
            
            **Request:** ${request}
            ${context_text ? `**Context:** ${context_text}` : ''}
            
            ‚è≥ Evaluating safety and generating code...
            
            _I'll update this comment with the PR link when ready!_
            
            ---
            <sub>Request ID: ${{ github.run_id }} | [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;
            
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: body
            });
            
            // Save comment ID for later updates
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `comment_id=${comment.data.id}\n`);

      - name: Trigger code generation workflow
        id: trigger
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Trigger the existing codex-generator workflow
          gh workflow run codex-generator.yml \
            --field request="${{ steps.parse.outputs.request }}" \
            --field context="${{ steps.parse.outputs.context }}" \
            --field triggered_by="comment" \
            --field comment_id="${{ steps.post_ack.outputs.comment_id }}" \
            --field issue_number="${{ github.event.issue.number }}"
          
          echo "‚úÖ Triggered codex-generator workflow"
          
          # Wait a moment for workflow to start
          sleep 5
          
          # Get the workflow run ID (most recent run of codex-generator)
          RUN_ID=$(gh run list --workflow=codex-generator.yml --limit 1 --json databaseId --jq '.[0].databaseId')
          
          echo "workflow_run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "üìä Workflow run ID: $RUN_ID"

      - name: Update comment with workflow link
        if: steps.trigger.outputs.workflow_run_id
        uses: actions/github-script@v7
        with:
          script: |
            const comment_id = '${{ steps.post_ack.outputs.comment_id }}';
            const run_id = '${{ steps.trigger.outputs.workflow_run_id }}';
            const request = `${{ steps.parse.outputs.request }}`;
            const context_text = `${{ steps.parse.outputs.context }}`;
            
            const body = `## ü§ñ Codexium V4 Request Received
            
            **Request:** ${request}
            ${context_text ? `**Context:** ${context_text}` : ''}
            
            ‚úÖ Generation workflow started!
            
            üîó [Watch Progress](https://github.com/${{ github.repository }}/actions/runs/${run_id})
            
            _I'll update this comment when the PR is created (~90 seconds)_
            
            ---
            <sub>Request ID: ${{ github.run_id }} | Generation Run: ${run_id}</sub>`;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment_id,
              body: body
            });

  # This job monitors the generation workflow and updates the comment when done
  monitor-generation:
    runs-on: ubuntu-latest
    needs: parse-and-trigger
    
    steps:
      - name: Wait for generation to complete
        uses: actions/github-script@v7
        timeout-minutes: 10
        with:
          script: |
            const run_id = '${{ needs.parse-and-trigger.outputs.workflow_run_id }}';
            
            // Poll every 10 seconds for up to 10 minutes
            let status = 'in_progress';
            let attempts = 0;
            const maxAttempts = 60; // 10 minutes
            
            while (status === 'in_progress' && attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              
              const run = await github.rest.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run_id
              });
              
              status = run.data.status;
              attempts++;
              
              console.log(`Attempt ${attempts}: Status = ${status}`);
            }
            
            // Get final conclusion
            const finalRun = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id
            });
            
            return {
              status: finalRun.data.status,
              conclusion: finalRun.data.conclusion
            };

      - name: Find created PR
        if: needs.parse-and-trigger.outputs.workflow_run_id
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            // Look for recently created PR with codexium label
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 5
            });
            
            // Find PR with codexium-generated label created in last 5 minutes
            const recentPR = prs.data.find(pr => {
              const labels = pr.labels.map(l => l.name);
              const createdAt = new Date(pr.created_at);
              const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
              
              return labels.includes('codexium-generated') && createdAt > fiveMinutesAgo;
            });
            
            if (recentPR) {
              return {
                found: true,
                number: recentPR.number,
                url: recentPR.html_url,
                title: recentPR.title
              };
            }
            
            return { found: false };

      - name: Update comment with PR link
        if: steps.find_pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment_id = '${{ needs.parse-and-trigger.outputs.comment_id }}';
            const pr_number = ${{ steps.find_pr.outputs.number }};
            const pr_url = '${{ steps.find_pr.outputs.url }}';
            const pr_title = '${{ steps.find_pr.outputs.title }}';
            const request = `${{ needs.parse-and-trigger.outputs.request }}`;
            
            const body = `## ‚úÖ Codexium V4 Generation Complete!
            
            **Request:** ${request}
            
            **Pull Request Created:** [#${pr_number} - ${pr_title}](${pr_url})
            
            ü§ñ Neo V4 is reviewing the code now...
            
            üìù **Next Steps:**
            1. Review the generated code in the PR
            2. Check Neo's automated review feedback
            3. Approve and merge when ready!
            
            ---
            <sub>Request ID: ${{ github.run_id }} | Total time: ~90 seconds</sub>`;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment_id,
              body: body
            });

      - name: Update comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment_id = '${{ needs.parse-and-trigger.outputs.comment_id }}';
            const run_id = '${{ needs.parse-and-trigger.outputs.workflow_run_id }}';
            const request = `${{ needs.parse-and-trigger.outputs.request }}`;
            
            const body = `## ‚ùå Codexium V4 Generation Failed
            
            **Request:** ${request}
            
            The code generation workflow encountered an error.
            
            üîç [View Error Details](https://github.com/${{ github.repository }}/actions/runs/${run_id})
            
            **Common Issues:**
            - Request may have been blocked by safety guardrails
            - OpenAI API issue
            - Invalid request format
            
            Please check the workflow logs and try again, or refine your request.
            
            ---
            <sub>Request ID: ${{ github.run_id }}</sub>`;
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment_id,
              body: body
            });
