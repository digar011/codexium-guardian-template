name: Codexium V4 - PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Prevent multiple reviews for the same PR
concurrency:
  group: codexium-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # -------------------------------------------------
  # 0. Check if we should run
  # -------------------------------------------------
  should_run:
    name: Check if review needed
    runs-on: ubuntu-latest
    outputs:
      run_review: ${{ steps.check.outputs.run_review }}
    
    steps:
      - name: Check PR state
        id: check
        run: |
          # Don't review draft PRs
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "run_review=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping draft PR"
            exit 0
          fi
          
          # Don't review bot PRs (like Codex's own PRs)
          if [[ "${{ github.event.pull_request.user.login }}" == *"bot"* ]]; then
            echo "run_review=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping bot PR"
            exit 0
          fi
          
          echo "run_review=true" >> $GITHUB_OUTPUT
          echo "âœ… Review needed"

  # -------------------------------------------------
  # 1. General review (always runs)
  # -------------------------------------------------
  general_review:
    name: General Code Review
    needs: should_run
    if: needs.should_run.outputs.run_review == 'true'
    uses: ./.github/workflows/codex-guardian.yml
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    with:
      role: general

  # -------------------------------------------------
  # 2. Specialized reviews (optional - comment out if too expensive)
  # -------------------------------------------------
  # architect_review:
  #   name: Architecture Review
  #   needs: should_run
  #   if: needs.should_run.outputs.run_review == 'true'
  #   uses: ./.github/workflows/codex-guardian.yml
  #   secrets:
  #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  #   with:
  #     role: architect

  # security_review:
  #   name: Security Review
  #   needs: should_run
  #   if: needs.should_run.outputs.run_review == 'true'
  #   uses: ./.github/workflows/codex-guardian.yml
  #   secrets:
  #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  #   with:
  #     role: security

  # -------------------------------------------------
  # 3. Post unified review comment
  # -------------------------------------------------
  post_review:
    name: Post Review to PR
    needs: [general_review] # Add architect_review, security_review if you enable them
    if: always() && needs.should_run.outputs.run_review == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Build review comment
        id: build_comment
        run: |
          cat > /tmp/review_comment.md << 'EOF'
          ## ðŸ¤– Codexium V4 Review
          
          **PR:** #${{ github.event.pull_request.number }}  
          **Author:** @${{ github.event.pull_request.user.login }}  
          **Reviewed:** $(date -u +"%Y-%m-%d %H:%M UTC")
          
          ---
          
          ### ðŸ“‹ General Review
          **Severity:** `${{ needs.general_review.outputs.severity }}`
          
          ${{ needs.general_review.outputs.review_output }}
          
          ---
          
          <!-- Uncomment when you enable specialized reviews
          ### ðŸ—ï¸ Architecture Review
          **Severity:** `${{ needs.architect_review.outputs.severity }}`
          
          ${{ needs.architect_review.outputs.review_output }}
          
          ---
          
          ### ðŸ”’ Security Review
          **Severity:** `${{ needs.security_review.outputs.severity }}`
          
          ${{ needs.security_review.outputs.review_output }}
          
          ---
          -->
          
          <sub>Powered by **Codexium V4** | [Feedback](https://github.com/${{ github.repository }}/issues)</sub>
          EOF
          
          cat /tmp/review_comment.md
      
      - name: Find existing review comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Codexium V4 Review'
      
      - name: Create or update review comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: /tmp/review_comment.md
          edit-mode: replace
      
      - name: Send Slack notification (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Get severity for color
          SEVERITY="${{ needs.general_review.outputs.severity }}"
          
          case "$SEVERITY" in
            critical) COLOR="danger" ;;
            warn) COLOR="warning" ;;
            *) COLOR="good" ;;
          esac
          
          # Send to Slack
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d @- <<EOF
          {
            "attachments": [
              {
                "color": "$COLOR",
                "title": "Codexium V4 Review: PR #${{ github.event.pull_request.number }}",
                "title_link": "${{ github.event.pull_request.html_url }}",
                "text": "${{ github.event.pull_request.title }}",
                "fields": [
                  {
                    "title": "Author",
                    "value": "${{ github.event.pull_request.user.login }}",
                    "short": true
                  },
                  {
                    "title": "Severity",
                    "value": "$SEVERITY",
                    "short": true
                  }
                ],
                "footer": "Codexium V4"
              }
            ]
          }
          EOF

